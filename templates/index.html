<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Downloader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 80px 20px 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        input[type="url"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="url"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }

        .result {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            display: none;
        }

        .result.show {
            display: block;
        }

        .video-info {
            margin-bottom: 20px;
        }

        .video-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .video-duration {
            color: #666;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success-message {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .download-link {
            display: inline-block;
            margin-top: 15px;
            padding: 12px 24px;
            background: #4caf50;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .download-link:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .status-message {
            color: #667eea;
            font-size: 0.95em;
            text-align: center;
            margin-top: 5px;
            font-weight: 500;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            font-size: 0.85em;
            color: #666;
        }

        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 1000;
        }

        .language-selector label {
            font-size: 0.9em;
            color: #666;
            margin: 0;
        }

        .language-selector select {
            padding: 6px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9em;
            background: white;
            color: #333;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .language-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .format-group {
            margin-top: 20px;
        }

        #formatSelect {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        #formatSelect:focus {
            outline: none;
            border-color: #667eea;
        }

        #formatSelect:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .container {
            position: relative;
        }

        .disclaimer {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
        }

        .disclaimer-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .disclaimer-text {
            color: #856404;
            font-size: 0.9em;
            line-height: 1.6;
            margin: 0;
        }

        .disclaimer-icon {
            display: inline-block;
            margin-right: 5px;
        }

        .video-preview {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            display: none;
            border: 2px solid #e0e0e0;
        }

        .video-preview.show {
            display: block;
        }

        .preview-header {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .preview-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .preview-thumbnail {
            flex: 0 0 200px;
            max-width: 100%;
        }

        .preview-thumbnail img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .preview-info {
            flex: 1;
            min-width: 250px;
        }

        .preview-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .preview-meta {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .preview-meta strong {
            color: #333;
            margin-right: 5px;
        }

        .preview-description {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            color: #666;
            font-size: 0.9em;
            line-height: 1.6;
            max-height: 150px;
            overflow-y: auto;
        }

        .preview-description.empty {
            color: #999;
            font-style: italic;
        }

        @media (max-width: 600px) {
            .preview-content {
                flex-direction: column;
            }
            .preview-thumbnail {
                flex: 0 0 auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-selector">
            <label for="languageSelect" data-i18n="language">èªè¨€</label>
            <select id="languageSelect" onchange="changeLanguage(this.value)">
                <option value="zh-TW" data-i18n="chinese_traditional">ç¹é«”ä¸­æ–‡</option>
                <option value="zh-CN" data-i18n="chinese_simplified">ç®€ä½“ä¸­æ–‡</option>
                <option value="en" data-i18n="english">English</option>
            </select>
        </div>

        <div class="disclaimer">
            <div class="disclaimer-title" data-i18n="disclaimer_title">
                âš ï¸ å…è²¬è²æ˜
            </div>
            <p class="disclaimer-text" data-i18n="disclaimer_text">
                æœ¬æ‡‰ç”¨ç¨‹å¼åƒ…ä¾›å€‹äººåˆæ³•ä½¿ç”¨ã€‚è«‹éµå®ˆå„å¹³å°çš„æœå‹™æ¢æ¬¾å’Œç‰ˆæ¬Šæ³•å¾‹ã€‚åš´ç¦ä½¿ç”¨æœ¬å·¥å…·ä¸‹è¼‰å—ç‰ˆæ¬Šä¿è­·çš„å…§å®¹ã€ä¾µçŠ¯ä»–äººçŸ¥è­˜ç”¢æ¬Šæˆ–é€²è¡Œä»»ä½•éæ³•æ´»å‹•ã€‚ä½¿ç”¨è€…éœ€è‡ªè¡Œæ‰¿æ“”ä½¿ç”¨æœ¬å·¥å…·çš„æ‰€æœ‰è²¬ä»»ï¼Œé–‹ç™¼è€…ä¸å°ä»»ä½•é•æ³•ä½¿ç”¨è¡Œç‚ºè² è²¬ã€‚
            </p>
        </div>

        <h1>ğŸ¬ <span data-i18n="app_title">Video Downloader</span></h1>
        <p class="subtitle" data-i18n="subtitle">è¼¸å…¥ç¶²å€ï¼Œè¼•é¬†ä¸‹è¼‰å½±ç‰‡</p>
        
        <div class="input-group">
            <label for="videoUrl" data-i18n="video_url_label">å½±ç‰‡ç¶²å€</label>
            <input 
                type="url" 
                id="videoUrl" 
                data-i18n-placeholder="video_url_placeholder"
                placeholder="https://www.youtube.com/watch?v=..." 
                autocomplete="off"
            >
        </div>

        <div class="button-group">
            <button class="btn-primary" id="extractBtn" onclick="extractVideo()" data-i18n="search_video">
                æœå°‹å½±ç‰‡
            </button>
            <button class="btn-secondary" id="downloadBtn" onclick="downloadVideo()" disabled data-i18n="download_video">
                ä¸‹è¼‰å½±ç‰‡
            </button>
        </div>

        <div class="format-group">
            <label for="formatSelect" data-i18n="format_label">ä¸‹è¼‰æ ¼å¼</label>
            <select id="formatSelect" disabled>
                <option value="" data-i18n="select_format">è«‹é¸æ“‡æ ¼å¼</option>
            </select>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p data-i18n="processing">è™•ç†ä¸­...</p>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="status-message" id="statusMessage"></div>
            <div class="progress-info">
                <span id="progressText">0%</span>
            </div>
        </div>

        <div class="error" id="error"></div>
        <div class="success-message" id="success"></div>

        <div class="video-preview" id="videoPreview">
            <div class="preview-header" data-i18n="video_preview">è¦–é »é è¦½</div>
            <div class="preview-content">
                <div class="preview-thumbnail" id="previewThumbnail">
                    <img id="thumbnailImage" src="" alt="" style="display: none;">
                    <div id="noThumbnail" style="display: none; text-align: center; padding: 40px; color: #999; background: #f0f0f0; border-radius: 8px;">
                        <span data-i18n="preview_not_available">é è¦½ä¸å¯ç”¨</span>
                    </div>
                </div>
                <div class="preview-info">
                    <div class="preview-title" id="previewTitle"></div>
                    <div class="preview-meta" id="previewMeta"></div>
                    <div class="preview-description" id="previewDescription"></div>
                </div>
            </div>
        </div>

        <div class="result" id="result">
            <div class="video-info">
                <div class="video-title" id="videoTitle"></div>
                <div class="video-duration" id="videoDuration"></div>
            </div>
        </div>
    </div>

    <script>
        // ç¿»è¯‘æ•°æ®
        let translations = {{ translations_data|tojson }};
        let currentLanguage = '{{ lang }}';
        
        // åˆå§‹åŒ–è¯­è¨€é€‰æ‹©å™¨
        document.getElementById('languageSelect').value = currentLanguage;
        const formatSelect = document.getElementById('formatSelect');
        let availableFormats = [];
        
        // ç¿»è¯‘å‡½æ•°
        function t(key) {
            if (translations && translations[currentLanguage] && translations[currentLanguage][key]) {
                return translations[currentLanguage][key];
            }
            return key;
        }
        
        // æ›´æ–°é¡µé¢ç¿»è¯‘
        function updateTranslations() {
            // æ›´æ–°HTML langå±æ€§
            document.documentElement.lang = currentLanguage;
            
            // æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-i18n å±æ€§çš„å…ƒç´ 
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key) {
                    el.textContent = t(key);
                }
            });
            
            // æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-i18n-placeholder å±æ€§çš„å…ƒç´ 
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (key) {
                    el.placeholder = t(key);
                }
            });
            
            // æ›´æ–°é€‰é¡¹æ–‡æœ¬
            document.querySelectorAll('#languageSelect option').forEach(option => {
                const key = option.getAttribute('data-i18n');
                if (key) {
                    option.textContent = t(key);
                }
            });
            
            // æ›´æ–°çŠ¶æ€æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ç¿»è¯‘keyï¼‰
            const statusMessage = document.getElementById('statusMessage');
            if (statusMessage) {
                const messageKey = statusMessage.getAttribute('data-i18n-key');
                if (messageKey) {
                    statusMessage.textContent = t(messageKey);
                }
            }
            
            // æ›´æ–°ä¸‹è½½é“¾æ¥æ–‡æœ¬
            const downloadLink = document.querySelector('.download-link');
            if (downloadLink && downloadLink.getAttribute('data-i18n-key')) {
                const linkKey = downloadLink.getAttribute('data-i18n-key');
                downloadLink.textContent = t(linkKey);
            }
        }
        
        // åˆ‡æ¢è¯­è¨€
        async function changeLanguage(lang) {
            try {
                const response = await fetch('/api/language', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ language: lang })
                });
                
                const data = await response.json();
                if (data.success) {
                    currentLanguage = lang;
                    // é‡æ–°åŠ è½½ç¿»è¯‘
                    const langResponse = await fetch('/api/language');
                    const langData = await langResponse.json();
                    if (langData.translations) {
                        translations[currentLanguage] = langData.translations;
                    }
                    updateTranslations();
                    
                    // å¦‚æœæ­£åœ¨è½®è¯¢çŠ¶æ€ï¼Œé‡æ–°è·å–çŠ¶æ€å¹¶æ›´æ–°ç¿»è¯‘
                    if (statusPollInterval) {
                        // è·å–å½“å‰ä»»åŠ¡IDï¼ˆä»URLæˆ–å­˜å‚¨çš„å˜é‡ï¼‰
                        const currentTaskId = document.getElementById('statusMessage')?.getAttribute('data-task-id');
                        if (currentTaskId) {
                            // é‡æ–°è·å–çŠ¶æ€å¹¶æ›´æ–°
                            try {
                                const statusResponse = await fetch(`/api/status/${currentTaskId}`);
                                const statusData = await statusResponse.json();
                                if (statusResponse.ok) {
                                    const messageKey = statusData.message_key || null;
                                    updateProgress(statusData.status, statusData.message, statusData.progress, messageKey);
                                }
                            } catch (e) {
                                console.error('Failed to refresh status:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Language change error:', error);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç¿»è¯‘
        updateTranslations();
        
        let currentUrl = '';
        let currentFormatId = 'best';
        let currentMethod = 'yt-dlp';
        let currentVideoUrl = null;
        let statusPollInterval = null;

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.classList.add('show');
        }

        function clearMessages() {
            const successDiv = document.getElementById('success');
            const errorDiv = document.getElementById('error');
            successDiv.classList.remove('show');
            successDiv.textContent = '';
            errorDiv.classList.remove('show');
            errorDiv.textContent = '';
        }

        function formatFilesize(bytes) {
            if (!bytes || bytes <= 0) return '';
            const mb = bytes / (1024 * 1024);
            if (mb >= 1024) {
                return `${(mb / 1024).toFixed(2)} GB`;
            }
            return `${mb.toFixed(1)} MB`;
        }

        function buildFormatLabel(format) {
            const parts = [];
            if (format.resolution && format.resolution !== 'unknown') {
                parts.push(`${t('resolution')}: ${format.resolution}`);
            }
            if (format.ext) {
                parts.push(format.ext.toUpperCase());
            }
            const sizeLabel = formatFilesize(format.filesize || format.filesize_approx);
            if (sizeLabel) {
                parts.push(`${t('filesize')}: ${sizeLabel}`);
            }
            if (format.quality && format.quality > 0) {
                parts.push(`Q${format.quality}`);
            }
            if (!parts.length) {
                parts.push(t('select_format'));
            }
            return parts.join(' â€¢ ');
        }

        function updateCurrentFormat(formatId, videoUrl = '') {
            currentFormatId = formatId && formatId !== '' ? formatId : 'best';
            if (videoUrl) {
                currentVideoUrl = videoUrl;
            } else if (currentMethod === 'html_parse' || currentMethod === 'instagram_parse') {
                const selectedFormat = availableFormats.find(f => f.format_id === currentFormatId);
                if (selectedFormat && selectedFormat.video_url) {
                    currentVideoUrl = selectedFormat.video_url;
                } else if (!currentVideoUrl && availableFormats.length) {
                    const fallback = availableFormats.find(f => f.video_url);
                    currentVideoUrl = fallback ? fallback.video_url : currentVideoUrl;
                }
            } else {
                currentVideoUrl = null;
            }
        }

        function populateFormats(formats = []) {
            availableFormats = formats || [];
            if (!formatSelect) return;

            formatSelect.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.setAttribute('data-i18n', 'select_format');
            defaultOption.textContent = t('select_format');
            formatSelect.appendChild(defaultOption);

            if (!formats || !formats.length) {
                formatSelect.disabled = true;
                updateCurrentFormat('best');
                return;
            }

            formats.forEach((fmt, index) => {
                const option = document.createElement('option');
                const value = fmt.format_id || `format_${index}`;
                option.value = value;
                option.textContent = buildFormatLabel(fmt);
                if (fmt.video_url) {
                    option.dataset.videoUrl = fmt.video_url;
                }
                formatSelect.appendChild(option);
            });

            formatSelect.disabled = false;
            const firstFormat = formats[0];
            if (firstFormat && firstFormat.format_id) {
                formatSelect.value = firstFormat.format_id;
                updateCurrentFormat(firstFormat.format_id, firstFormat.video_url || '');
            } else {
                formatSelect.value = '';
                updateCurrentFormat('best');
            }
        }

        function formatDuration(seconds) {
            if (!seconds || seconds === 0) return t('unknown');
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function formatNumber(num) {
            if (!num || num === 0) return '0';
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr.length !== 8) return '';
            try {
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                return `${year}-${month}-${day}`;
            } catch {
                return dateStr;
            }
        }

        function showVideoPreview(data) {
            const previewDiv = document.getElementById('videoPreview');
            const thumbnailImg = document.getElementById('thumbnailImage');
            const noThumbnail = document.getElementById('noThumbnail');
            const previewTitle = document.getElementById('previewTitle');
            const previewMeta = document.getElementById('previewMeta');
            const previewDescription = document.getElementById('previewDescription');

            // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
            previewDiv.classList.add('show');

            // è®¾ç½®ç¼©ç•¥å›¾
            if (data.thumbnail) {
                thumbnailImg.src = data.thumbnail;
                thumbnailImg.alt = data.title || '';
                thumbnailImg.style.display = 'block';
                noThumbnail.style.display = 'none';
            } else {
                thumbnailImg.style.display = 'none';
                noThumbnail.style.display = 'block';
            }

            // è®¾ç½®æ ‡é¢˜
            previewTitle.textContent = data.title || t('unknown_title');

            // è®¾ç½®å…ƒä¿¡æ¯
            let metaHtml = '';
            if (data.duration) {
                metaHtml += `<div><strong>${t('duration')}:</strong> ${formatDuration(data.duration)}</div>`;
            }
            if (data.uploader) {
                metaHtml += `<div><strong>${t('video_uploader')}:</strong> ${data.uploader}</div>`;
            }
            if (data.view_count && data.view_count > 0) {
                metaHtml += `<div><strong>${t('video_view_count')}:</strong> ${formatNumber(data.view_count)}</div>`;
            }
            if (data.upload_date) {
                metaHtml += `<div><strong>${t('video_upload_date')}:</strong> ${formatDate(data.upload_date)}</div>`;
            }
            previewMeta.innerHTML = metaHtml || '<div style="color: #999;">' + t('preview_not_available') + '</div>';

            // è®¾ç½®æè¿°
            if (data.description && data.description.trim()) {
                previewDescription.textContent = data.description;
                previewDescription.classList.remove('empty');
                // é™åˆ¶æè¿°é•¿åº¦
                if (data.description.length > 500) {
                    previewDescription.textContent = data.description.substring(0, 500) + '...';
                }
            } else {
                previewDescription.textContent = t('preview_not_available');
                previewDescription.classList.add('empty');
            }
        }

        function updateProgress(status, message, progress, messageKey = null) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const statusMessage = document.getElementById('statusMessage');
            const progressText = document.getElementById('progressText');

            progressContainer.classList.add('show');
            progressBar.style.width = progress + '%';
            
            // å¦‚æœæœ‰ç¿»è¯‘keyï¼Œä½¿ç”¨å½“å‰è¯­è¨€ç¿»è¯‘ï¼›å¦åˆ™ä½¿ç”¨åŸå§‹æ¶ˆæ¯
            if (messageKey) {
                const translated = t(messageKey);
                statusMessage.textContent = translated;
                // å­˜å‚¨ç¿»è¯‘keyä»¥ä¾¿è¯­è¨€åˆ‡æ¢æ—¶é‡æ–°ç¿»è¯‘
                statusMessage.setAttribute('data-i18n-key', messageKey);
            } else {
                statusMessage.textContent = message;
                statusMessage.removeAttribute('data-i18n-key');
            }
            
            progressText.textContent = progress + '%';
        }

        function stopProgressPolling() {
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
                statusPollInterval = null;
            }
        }

        async function pollDownloadStatus(taskId) {
            stopProgressPolling();
            
            // å­˜å‚¨å½“å‰ä»»åŠ¡IDä»¥ä¾¿è¯­è¨€åˆ‡æ¢æ—¶ä½¿ç”¨
            const statusMessage = document.getElementById('statusMessage');
            if (statusMessage) {
                statusMessage.setAttribute('data-task-id', taskId);
            }
            
            statusPollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/status/${taskId}`);
                    const data = await response.json();

                    if (response.ok) {
                        // ä½¿ç”¨message_keyè¿›è¡Œç¿»è¯‘ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨message
                        const messageKey = data.message_key || null;
                        updateProgress(data.status, data.message, data.progress, messageKey);

                        if (data.status === 'completed') {
                            stopProgressPolling();
                            showLoading(false);
                            updateProgress('completed', t('status_completed'), 100, 'status_completed');
                            
                            // å‰µå»ºä¸‹è¼‰éˆæ¥
                            const downloadLink = document.createElement('a');
                            downloadLink.href = data.download_url;
                            downloadLink.className = 'download-link';
                            downloadLink.textContent = t('click_to_download');
                            downloadLink.setAttribute('data-i18n-key', 'click_to_download');  // å­˜å‚¨ç¿»è¯‘key
                            downloadLink.download = data.filename;
                            
                            // æ¸…é™¤ä¹‹å‰çš„éˆæ¥
                            const resultDiv = document.getElementById('result');
                            const oldLink = resultDiv.querySelector('.download-link');
                            if (oldLink) {
                                oldLink.remove();
                            }
                            
                            resultDiv.appendChild(downloadLink);
                            showSuccess(t('download_prepared'));

                            // è‡ªå‹•è§¸ç™¼ä¸‹è¼‰
                            setTimeout(() => {
                                downloadLink.click();
                            }, 500);

                            document.getElementById('downloadBtn').disabled = false;
                        } else if (data.status === 'error') {
                            stopProgressPolling();
                            showLoading(false);
                            showError(data.message || t('download_failed'));
                            document.getElementById('downloadBtn').disabled = false;
                        }
                    } else {
                        stopProgressPolling();
                        showLoading(false);
                        showError(t('cannot_get_status'));
                        document.getElementById('downloadBtn').disabled = false;
                    }
                } catch (error) {
                    console.error('Status polling error:', error);
                }
            }, 500); // æ¯500msè¼ªè©¢ä¸€æ¬¡
        }

        if (formatSelect) {
            formatSelect.addEventListener('change', (event) => {
                const selectedOption = event.target.options[event.target.selectedIndex];
                const videoUrl = selectedOption ? selectedOption.dataset.videoUrl || '' : '';
                updateCurrentFormat(event.target.value, videoUrl);
            });
        }

        populateFormats([]);

        async function extractVideo() {
            const url = document.getElementById('videoUrl').value.trim();
            clearMessages();
            populateFormats([]);
            
            if (!url) {
                showError(t('enter_video_url'));
                return;
            }

            currentUrl = url;
            currentMethod = 'yt-dlp';
            currentVideoUrl = null;
            showLoading(true);
            document.getElementById('result').classList.remove('show');
            document.getElementById('videoPreview').classList.remove('show');
            document.getElementById('extractBtn').disabled = true;

            try {
                const response = await fetch('/api/extract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || t('extract_failed'));
                }

                // ä¿å­˜æå–æ–¹æ³•å’Œè¦–é »URL
                currentMethod = data.method || 'yt-dlp';
                if (data.video_urls && data.video_urls.length > 0) {
                    currentVideoUrl = data.video_urls[0].url;
                } else if (data.formats && data.formats.length > 0 && data.formats[0].video_url) {
                    currentVideoUrl = data.formats[0].video_url;
                } else {
                    currentVideoUrl = null;
                }
                
                // é¡¯ç¤ºè¦–é »é è¦½
                showVideoPreview(data);
                
                // é¡¯ç¤ºè¦–é »ä¿¡æ¯ï¼ˆç°¡åŒ–ç‰ˆï¼Œç”¨æ–¼çµæœå€åŸŸï¼‰
                document.getElementById('videoTitle').textContent = data.title || t('unknown_title');
                const duration = data.duration || 0;
                let durationText = '';
                if (duration > 0) {
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    durationText = `${t('duration')}: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    durationText = `${t('duration')}: ${t('unknown')}`;
                }
                document.getElementById('videoDuration').textContent = durationText;
                
                // é¡¯ç¤ºæå–æ–¹æ³•
                let methodText = '';
                if (currentMethod === 'html_parse') {
                    methodText = ' ' + t('using_html_parse');
                } else if (currentMethod === 'instagram_parse') {
                    methodText = ' ' + t('using_instagram_parse');
                }
                document.getElementById('videoDuration').textContent += methodText;
                
                document.getElementById('result').classList.add('show');
                document.getElementById('downloadBtn').disabled = false;
                populateFormats(data.formats || []);
                
                let successMsg = t('video_info_extracted');
                if (currentMethod === 'html_parse') {
                    successMsg += t('using_fallback');
                } else if (currentMethod === 'instagram_parse') {
                    successMsg += t('instagram_post');
                }
                showSuccess(successMsg);

            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
                document.getElementById('extractBtn').disabled = false;
            }
        }

        async function downloadVideo() {
            clearMessages();

            if (!currentUrl) {
                showError(t('search_first'));
                return;
            }

            // åœæ­¢ä¹‹å‰çš„è¼ªè©¢
            stopProgressPolling();

            showLoading(true);
            document.getElementById('progressContainer').classList.remove('show');
            document.getElementById('downloadBtn').disabled = true;

            try {
                const requestBody = { 
                    url: currentUrl,
                    format_id: currentFormatId,
                    method: currentMethod
                };
                
                // å¦‚æœæ˜¯HTMLè§£ææˆ–Instagramè§£ææ–¹å¼ï¼Œå‚³éè¦–é »URL
                if (currentVideoUrl && (currentMethod === 'html_parse' || currentMethod === 'instagram_parse')) {
                    requestBody.video_url = currentVideoUrl;
                }
                
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || t('download_failed'));
                }

                // é–‹å§‹è¼ªè©¢ç‹€æ…‹
                showLoading(false);
                updateProgress('processing', t('status_starting'), 0, 'status_starting');
                pollDownloadStatus(data.task_id);

            } catch (error) {
                stopProgressPolling();
                showLoading(false);
                showError(error.message);
                document.getElementById('downloadBtn').disabled = false;
            }
        }

        // æ”¯æŒEnteréµæäº¤
        document.getElementById('videoUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                extractVideo();
            }
        });
    </script>
</body>
</html>

